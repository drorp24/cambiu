<div class="container-fluid">
	<div class="row">
		<div id="map_container" class="col-md-5 col-md-offset-1">
			<div id="map-canvas"></div>			
		</div>
		<div class="col-md-4 col-md-offset-2">
			<h2>This is your map</h2>
		</div>
	</div>
</div>
<div id="exchange_info">
	Hi folks, I am the exchange info!
</div>
<script>

$(document).ready(function() {

  // mixpanel people.set

	var london = new google.maps.LatLng(51.507351, -0.127758);

	var exchanges = [
		<% Exchange.where(city: "London").each do |exchange| %>
			<% next unless exchange.latitude and exchange.longitude %>
	  		[<%= exchange.id.to_s %>, <%= exchange.latitude %>, <%= exchange.longitude %>, '<%= exchange.name %>'],
  		<% end %>
  		[<%= Exchange.last.id.to_s %>, <%= Exchange.last.latitude %>, <%= Exchange.last.longitude %>, '<%= Exchange.last.name %>']
	];

	var markers = [];
	var map;

 	function initialize() {
		var mapOptions = {
	      center: london,
	      zoom: 14
	    };    
		map = new google.maps.Map(document.getElementById('map-canvas'),
          	mapOptions);
      	drop(); 	
  
  	function drop() {
	  clearMarkers();
	  for (var i = 0; i < exchanges.length; i++) {
//	    window.setTimeout(function() {
	      addMarker(exchanges[i]);
//	    }, i * 200);
	  }
	}
	
	var cambiuIcon = '<%= image_path 'icon.png' %>';

	function addMarker(exchange) {
	  	var marker = new google.maps.Marker({
		    position: new google.maps.LatLng(exchange[1], exchange[2]),
		    title: exchange[3],
		    map: map,
		    icon: cambiuIcon,
		    animation: google.maps.Animation.DROP,
		    zIndex: exchange[0] // holds the exchange id 
	  	})
	  	
	  	markers.push(marker);
	  	
	  	google.maps.event.addListener(marker, 'click', function() {
	  		$.getJSON(
	  			'/exchanges/' + marker.zIndex + '/quote', {
	  				buy_amount: 	getParameterByName('buy_amount'),
	  				buy_currency: 	getParameterByName('buy_currency'),
	  				pay_currency:	getParameterByName('pay_currency')
	  			})
  			.done(function(data) {
				$('#exchange_info').html(data.fractional);
			})
			var infowindow = new google.maps.InfoWindow({
	      		content: $('#exchange_info').html()
	  		});
    		infowindow.open(map,marker);
  		});
	}
	
	function clearMarkers() {
	  	for (var i = 0; i < markers.length; i++) {
	    markers[i].setMap(null);
  		}
  		markers = [];
	}

}	 
 	google.maps.event.addDomListener(window, 'load', initialize);

});
</script>
