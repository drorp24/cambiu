<script>

$(document).ready(function() {
	

//  ToDo: mixpanel people.set

	var map;
	var markers = [];
	var exchanges = [];
	var exchanges_array = []
	var current_state;
//	var service = new google.maps.places.PlacesService(map);

 	function initialize() {
 		
		// dont load map in mobile
 		if (desktop) {
			var mapOptions = {
		      center: new google.maps.LatLng(latitude, longitude),
		      zoom: 12
		    };    
	
			map = new google.maps.Map(document.getElementById('map-canvas'),
	          	mapOptions);
      	}

      	search(location_search, latitude, longitude, distance, buy_currency, pay_currency, pay_amount, sort); 	
	}
  
	function search(location_search, latitude, longitude, distance, pay_currency, buy_currency, pay_amount, sort) {
		$.get(
		'/exchanges/search', {
			location_search: 	location_search,
			latitude:			latitude,
			longitude:			longitude,
			distance:			distance,
			pay_currency:		pay_currency,
			buy_currency: 		buy_currency,
			pay_amount: 		pay_amount,
			sort:				sort
		})
		.done(function(exchanges) {
			if (desktop) {updateMarkers(exchanges)};
			updateParamsDisplay();
			exchanges_array = exchanges;
			updateExchanges(exchanges)
		})		
	}	

  	function updateMarkers(exchanges) {
	  clearMarkers();
	  for (var i = 0; i < Math.min(exchanges.length, 30); i++) {
	      addMarker(exchanges[i]);
	  }
	}
	
	function addMarker(exchange) {
	  	var marker = new google.maps.Marker({
		    position: new google.maps.LatLng(exchange.latitude, exchange.longitude),
		    title: exchange.name,
		    map: map,
		    icon: '<%= image_path 'icon.png' %>',
//		    animation: google.maps.Animation.DROP,
		    zIndex: exchange.id // holds the exchange id 
	  	})
	  	
	  	if (exchange.quote) {
	  		var infowindow = new google.maps.InfoWindow({
      			content: String(exchange.edited_quote)
  			});
  			infowindow.open(map,marker);
		}
	  	
	  	markers.push(marker);
	  	
		var id = "#exchange_det_" + String(exchange.id);	
	  	google.maps.event.addListener(marker, 'click', function() {
    		$('.list-group-item[href="0"]'.replace("0", id)).addClass('active');
  		});


/*
	  	google.maps.event.addDomListener(document.querySelector('.list-group-item[href="0"]'.replace("0", id)), 'click', function() {
			var infowindow = new google.maps.InfoWindow({
	      		content: String(exchange.name)
	  		});
    		infowindow.open(map,marker);
  		});
*/
	}
	
	function clearMarkers() {
	  	for (var i = 0; i < markers.length; i++) {
	    	markers[i].setMap(null);
  		}
  		markers = [];
	}
	
	
	function addExchange(exchange, index) {

		var exchange_el = 	$('.template').clone().removeClass('template');
		var exchange_sum = 	exchange_el.find('.list-group-item')
		var exchange_det = 	exchange_el.find('.collapse')
		var id = '#exchange_det_' + exchange.id

		exchange_sum.attr('href', id)
		exchange_det.attr('id', id)
		
		exchange_sum.html(exchange.name + ' Distance: ' + String(exchange.distance) + ' Quote: ' + String(exchange.quote))
		exchange_det.find('.well').html(exchange.id)
		
		exchange_el.appendTo('#exchanges_list .list-group')
		exchange_el.find('.list-group-item').unwrap()
		
/*		
		exchange_el = $('.exchange_' + String(index));
		exchange_el.find('.badge').html(exchange.edited_quote);
		exchange_el.find('.name').html(exchange.name);
		exchange_el.find('.address').html(exchange.address);
		exchange_el.find('.open_today').html(exchange.open_today);
//		place_photo(exchange);
		exchange_el.css('visibility', 'visible');
		exchange_el.show();
*/
	


	function place_photo(exchange) {
		var request = {query: exchange.name + ' ' + exchange.address};
		
		var service = new google.maps.places.PlacesService(map);
		service.textSearch(request, gp_ts_callback);
		
		function gp_ts_callback(results, status) {
			console.log('gp_ts_callback');
			if (status == google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
		    		      
			    var place = results[0];
			    var place_id = place.place_id
			    console.log("place_id: " + place_id)
			      
			    var request = {placeId: place_id};
//			    service.getDetails(request, gp_pd_callback);
			      
		    	function gp_pd_callback(place, status) {
		    		console.log('gp_pd_callback');
				  	if (status == google.maps.places.PlacesServiceStatus.OK) {
					    if (place.photos.length > 0) {
					    	photo_url = place.photos[0].getUrl();
					    	console.log("photo_url: " + photo_url);
					    	
					  	}
				   	}		    
		  		}
			}
		}
	}
	
	}
	
	function clearExchanges() {
		$('#exchanges_list .list-group').empty();
	}
	
	
 	google.maps.event.addDomListener(window, 'load', initialize);
 	
 	function sort_by_distance() {
 		exchanges_array.sort(function(a, b){return a.distance-b.distance});
 		updateExchanges(exchanges_array);
//		updateMarkers(exchanges);
//		updateParamsDisplay();
//		exchanges_array = exchanges;
	}
  	function sort_by_amount() {
 		exchanges_array.sort(function(a, b){return (a.quote ? a.quote : 10000000)-(b.quote ? b.quote : 10000000)});
 		updateExchanges(exchanges_array);
//		updateMarkers(exchanges);
//		updateParamsDisplay();
//		exchanges_array = exchanges;
 	}
 	
 	
	function updateExchanges(exchanges) {
		clearExchanges();
	  	for (var i = 0; i < exchanges.length; i++) {
	    	addExchange(exchanges[i], i);
	  	}
	  	
	  	$('.list-group-item').click(function() {
	  		$(this).next().toggleClass('in')
	  	})

//	  	$('.collapse').collapse()		
	}
	
	$('#search_form #search_button').click(function(event) {
		location_search =   $('#search_form #location_search').val();
		latitude =          $('#search_form #latitude').val() || 51.507351;
		longitude =         $('#search_form #longitude').val() || -0.127758;
		geocoded_location = $('#search_form #geocoded_location').val();
		distance =          $('#search_form #distance').val();
		pay_currency =      $('#search_form #pay_currency').val();
		buy_currency =      $('#search_form #buy_currency').val();
		pay_amount =        $('#search_form #pay_amount').val();
		sort =              $('#search_form #sort').bootstrapSwitch('state') ? 'amount' : 'distance';
		searched_location = (location_search ? location_search : ((latitude && longitude) ? "nearby" : "London"));
		
		search(location_search, latitude, longitude, distance, buy_currency, pay_currency, pay_amount, sort);
		event.preventDefault();

	})


	$('#search_form #sort').on('switchChange.bootstrapSwitch', function(event, state) {
	  if (state) {
	  	sort_by_amount();	
	  } else {
	  	sort_by_distance();	
	  }
	});	
	 	


});
</script>


<div class="container-fluid">

	<div id="exchanges_page">
		<div class="row">
			<div id="exchanges" class="col-md-6 col-xs-12">
				<div  id="exchanges_list">	
				<div id="exchanges_header" class="list-group-item">
					<div>
						<button id="distance" class="btn btn-success">Distance</button>
						<button id="quote" class="btn btn-success">Quote</button>
					</div>
				</div> 
					<div class="list-group">
						<!--   Exchange list goes here -->
					</div>
				</div>
			</div>
		</div>
		<div id="map_container" class="col-md-6 col-md-offset-6">
			<div id="map-canvas"></div>			
		</div>
	</div>		

	
	<!--   Exchange template  -->
	<div class="template" style="display: none">

		<a class="list-group-item" data-toggle="collapse" href="#exchange_det_0" aria-expanded="false" aria-controls="collapseExample">
			
		</a>
		<div class="collapse" id="exchange_det_0">
			<div class="well">
			</div>
	  	</div>
	</div>			  			  	

</div>
