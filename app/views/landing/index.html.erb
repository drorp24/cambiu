<div id="landing_page">
	<div id="fluid" class="container-fluid photo_background">
		<div id="landing_background">
			<!--<video id="video_background" preload="auto" autoplay="autoplay" loop="loop" style="position: fixed; top: 0px; left: 0px; bottom: 0px; right: 0px; z-index: -100;"><source src="preview.mp4" type="video/mp4"></source>bgvideo</video>--> 				
		</div>
		<div id="landing_header">
			<div class="row">
	  			<div id="landing_name" class="text-center"></div>			
			</div>
		</div>
		<div id="landing_message">
			<div class="row">
				<div id="message" class="text-center">
					<div id="message_header"><%= t :title, scope: [@landing], default: 'Best currency exchange deals near you' %></div>
					<div class="col-md-6 col-md-offset-3" id="message_remainder">
						<%= t :text, scope: [@landing], default: 'Save on high commission fees with a few simple clicks. Anytime. Anywhere.' %>
					</div>
				</div>
			</div>
		</div>
		<div id="landing_form">
			<div class="row">
				<form id="new_user" method="post" action="/users" class="form-inline col-md-8 col-md-offset-2 col-xs-offset-1">
					<div id="mobile_input_trigger" class="form-group col-md-3 col-xs-10">
						<input class="form-control" placeholder="Check rates">
				  	</div>
					<div class="form-group col-md-3 col-xs-11">
						<input id="user_pay_amount" data-autonumeric="true" name="user[pay_amount]" class="form-control" placeholder="Change">
				  	</div>
				  	<div class="form-group col-md-3 col-xs-11">
						<select id="user_pay_currency" name="user[pay_currency]" class="select optional text-center form-control">
							<option value="GBP" selected="selected">GBP</option>
							<option value="EUR">EUR</option>
							<option value="USD">USD</option>
							<option value="AUD">AUD</option>
							<option value="CAD">CAD</option>
							<option value="JPY">JPY</option>
						</select>
					</div>
				  	<div id="the-basics" class="form-group col-md-3 col-xs-11">
						<select id="user_buy_currency" name="user[buy_currency]" class="select optional text-center form-control">
							<option value="USD" selected="selected">USD</option>
							<option value="EUR">EUR</option>
							<option value="GBP">GBP</option>
							<option value="AUD">AUD</option>
							<option value="CAD">CAD</option>
							<option value="JPY">JPY</option>
						</select>
				  	</div>
				  	<div class="hidden" style="display:none">
				  		<input id="user_pay_amount" type="hidden" name="user[pay_amount]">
				  		<input type="hidden" name="user[latitude]" value="51.507351">
				  		<input type="hidden" name="user[longitude]" value="-0.127758">
				  		<input type="hidden" name="user[bbox]" value="default">
				  		<input type="hidden" name="user[landing]" value="<%= @landing %>">
				  		<input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
					</div>
				  	<div id="serach_div" class="form-group col-md-3 col-xs-11">
						<button id="search_button" class="form-control btn btn-success" type="button"><%= t :search_button, scope: [@landing], default: 'Get it' %></button>
					</div>
				  	<div class="email_group form-group col-md-3 col-xs-11" style="display: none">
						<input id="offer" type="text" name="offer" class="form-control not-input">
				  	</div>
				  	<div class="email_group form-group col-md-3 col-xs-11" style="display: none">
						<input id="signin_request" type="text" name="signin_request" class="form-control not-input">
				  	</div>
				  	<div class="email_group form-group col-md-3 col-xs-11" style="display: none">
						<input id="user_email" type="email" name="user[email]" class="form-control" placeholder="Your email">
				  	</div>
				  	<div class="email_group form-group col-md-3 col-xs-11" style="display: none">
						<button id="email_button" class="form-control btn btn-success" type="text"><%= t :signin_button, scope: [@landing], default: 'Get it' %></button>
					</div>
				</form>
			</div>
		</div>
		
		<div id="landing_footer">
		</div>
	</div>
</div>
<script>
$(document).ready(function() {
	

	// hide address bar - not working as of iOS7
	window.addEventListener("load",function() {
	// Set a timeout...
	setTimeout(function(){
		// Hide the address bar!
		window.scrollTo(0, 1);
	}, 0);
	});


	// Store user location in hidden form fields
	getLocation();
	

	// rails' jquery_ujs remote by hand
	$('#new_user').submit(function() {  
	    var valuesToSubmit = $(this).serialize();
	    $.ajax({
	        type: "POST",
	        url: $(this).attr('action'), 
	        data: valuesToSubmit,
	        dataType: "JSON",
	    }).success(function(json){
	        //act on result.
	    });
	    return false; // prevents normal behaviour
	});

	// Analyses & Flow
	$('#mobile_input_trigger input').click(function() {
		ga('send', 'event', 'button', 'click', 'First mobile click');
		mixpanel.track('First mobile click');
		$('#mobile_input_trigger').css('display', 'none');
		$('.form-group:not(#mobile_input_trigger, .email_group)').css('display', 'block');
		$('#user_buy_amount').focus();
	})

	$('#user_pay_amount, #user_pay_currency, #user_buy_currency').change(function() {
		ga('send', 'event', 'button', 'click', 'Populating rates');
		mixpanel.track('Checking rates');
	})

	$('#search_button').click(function() {
		ga('send', 'event', 'button', 'click', 'Clicking search');
		mixpanel.track("Search button");

		var pay_cents =    $('#user_pay_amount').val().replace(',', '').replace('.', '');
		var pay_currency = $('#user_pay_currency').val();
		var buy_currency = $('#user_buy_currency').val();

		$.get('/currencies/exchange', {
			pay_cents: pay_cents,
			pay_currency: pay_currency,
			buy_currency: buy_currency
		}
		).done(function(data) {
			if (data == null) {
				location.reload(); 				
			} else {
				$('.form-group:not(.email_group)').css('display', 'none');
				$('.email_group').css('display', 'block');
				console.log(data)
				$('#message_header').html('<%= t :offer_prefix, scope: [@landing], default: 'We can offer you ' %>' + data);
				$('#message_remainder').html('<%= t :signin_request, scope: [@landing], default: 'Interested? Sign-in' %>');
			}
		})
	});

	$('#email_button').click(function() {
		ga('send', 'event', 'button', 'click', 'Leaving email');
		mixpanel.track("Email button");
		$('#message_header').html('<%= t :thanks_title, scope: [@landing], default: 'Thank you for your interest!' %>')
		if ($('#user_email').val()) {
			$('#message_remainder').html('<%= t :thanks_text, scope: [@landing], default: 'We will let you know as soon as we launch!' %>')			
		}
	})
	





// typeahead - with override issues

	$('.typeahead.input-sm').siblings('input.tt-hint').addClass('hint-small');
	$('.typeahead.input-lg').siblings('input.tt-hint').addClass('hint-large');	
	
	var substringMatcher = function(strs) {
  		return function findMatches(q, cb) {
    	var matches, substrRegex;
 
	    // an array that will be populated with substring matches
	    matches = [];
	 
	    // regex used to determine if a string contains the substring `q`
	    substrRegex = new RegExp(q, 'i');
	 
	    // iterate through the pool of strings and for any string that
	    // contains the substring `q`, add it to the `matches` array
	    $.each(strs, function(i, str) {
	      if (substrRegex.test(str)) {
	        // the typeahead jQuery plugin expects suggestions to a
	        // JavaScript object, refer to typeahead docs for more info
	        matches.push({ value: str });
      }
    });
 
    cb(matches);
  };
};
 
var currencies = ['GBP', 'USD', 'EUR', 'AUD', 'CAD', 'JPY'];
 
$('#new_user .typeahead').typeahead({
  hint: true,
  highlight: true,
  minLength: 1
},
{
  name: 'currencies',
  displayKey: 'value',
  source: substringMatcher(currencies)
});

})
</script>
